<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=koi8-r">


<TITLE>Autoconf - Обновление с версии 1</TITLE>
</HEAD>
<body><b><a href="http://www.opennet.ru/docs/">Архив документации OpenNet.ru</a> / 
Раздел "<a href="http://www.opennet.ru/docs/124.shtml">Программирование, языки</a>" /
<a href="index.html">Индекс</a>
</b>
<hr noshade size=1>

Go to the <A HREF="autoconf-ru_1.html">first</A>, <A HREF="autoconf-ru_12.html">previous</A>, <A HREF="autoconf-ru_14.html">next</A>, <A HREF="autoconf-ru_19.html">last</A> section, <A HREF="autoconf-ru_toc.html">table of contents</A>.
<P><HR><P>


<H1><A NAME="SEC96" HREF="autoconf-ru_toc.html#TOC96">Обновление с версии 1</A></H1>
<P>
@anchor{Upgrading}


<P>
По большей части Autoconf версии 2 обратно совместим с версией 1.
Однако же, в нем появились более удобные способы решения некоторых
вещей, а некоторые особенно уродливые способы из версии 1 не
поддерживаются.  Так что, в зависимости от сложности ваших файлов
<TT>`configure.in'</TT>, вам, может быть, придется вручную скорректировать
ваши файлы, чтобы использовать их с Autoconf версии 2. Этот раздел описывает некоторые
проблемы, которых можно ожидать при переходе к новой версии.  Также,
возможно, ваши скрипты <CODE>configure</CODE> получат выгоду от
использования новых возможностей версии 2; список изменений приведен в
файле <TT>`NEWS'</TT> дистрибутива Autoconf.


<P>
В первую очередь убедитесь, что у вас установлен GNU <CODE>m4</CODE> версии
1.1 или более свежей, предпочтительней использовать версию 1.3 или
следующие. Версии до 1.1 имели ошибку, которая препятствовала их работе
с Autoconf версии 2. Версии 1.3 и более поздние работают быстрее,
чем более ранние версии, поскольку с версии 1.3 GNU <CODE>m4</CODE> имеет
более эффективную реализацию diversions и может сохранить свое
состояние в файле, который потом может быстро считан обратно.




<H2><A NAME="SEC97" HREF="autoconf-ru_toc.html#TOC97">Измененные имена файлов</A></H2>
<P>
@anchor{Changed File Names}


<P>
Если у вас есть файл <TT>`aclocal.m4'</TT>, установленный вместе с Autoconf
(а не в каталоге с исходными текстами), то вы
должны переименовать его в <TT>`acsite.m4'</TT>.  See section <A HREF="autoconf-ru_2.html#SEC6">Использование программы <CODE>autoconf</CODE> для создания скрипта <CODE>configure</CODE></A>.


<P>
Если вы распространяете с вашим пакетом файл <TT>`install.sh'</TT>, то
переименуйте его в <TT>`install-sh'</TT>, так что встроенные правила
<CODE>make</CODE> не будут создавать на его основе файл
<TT>`install'</TT>. <CODE>AC_PROG_INSTALL</CODE> ищет файл, пользуясь обоими
именами, но лучше использовать новое имя.


<P>
Если вы используете <TT>`config.h.top'</TT> или <TT>`config.h.bot'</TT>, то вы
все равно сможете их использовать, но будет лучше, если вы
объедините их в файл <TT>`acconfig.h'</TT>. See section <A HREF="autoconf-ru_3.html#SEC17">Использование <CODE>autoheader</CODE> для создания <TT>`config.h.in'</TT></A>.




<H2><A NAME="SEC98" HREF="autoconf-ru_toc.html#TOC98">Измененные файлы Makefile</A></H2>
<P>
@anchor{Changed Makefiles}


<P>
Добавьте <SAMP>`@CFLAGS@'</SAMP>, <SAMP>`@CPPFLAGS@'</SAMP> и <SAMP>`@LDFLAGS@'</SAMP> в
ваши файлы <TT>`Makefile.in'</TT>, чтобы туда попадали значения
соответствующих переменных среды, установленные при запуске
<CODE>configure</CODE>.  Это необязательно, но удобно для
пользователей.


<P>
Также добавьте <SAMP>`@configure_input@'</SAMP> в комментарий каждого из
входных файлов макроса <CODE>AC_OUTPUT</CODE>, кроме файлов <TT>`Makefile'</TT>,
чтобы выходные файлы содержали сообщение о том, что они созданы скриптом
<CODE>configure</CODE>. Автоматический выбор синтаксиса для комментариев в
файлах, для которых вызывается <CODE>AC_OUTPUT</CODE>, было бы слишком сложно.


<P>
Добавьте <TT>`config.log'</TT> и <TT>`config.cache'</TT> в список файлов,
которые вы удаляете с помощью цели <CODE>distclean</CODE>.


<P>
Если у вас в <TT>`Makefile.in'</TT> имеется следующее:



<PRE>
prefix = /usr/local
exec_prefix = ${prefix}
</PRE>

<P>
то вы должны изменить эту запись на следующую:



<PRE>
prefix = @prefix@
exec_prefix = @exec_prefix@
</PRE>

<P>
Старое поведение замены переменных без знаков <SAMP>`@'</SAMP> вокруг них
было удалено.




<H2><A NAME="SEC99" HREF="autoconf-ru_toc.html#TOC99">Измененные макросы</A></H2>
<P>
@anchor{Changed Macros}


<P>
В Autoconf версии 2 многие макросы были переименованы.  Вы все равно
можете использовать старые имена, но новые имена макросов более понятны
и для них легче найти документацию. See section <A HREF="autoconf-ru_15.html#SEC109">Старые имена макросов</A>, где приведена таблица соответствия новых имен старым именам.
Используйте программу <CODE>autoupdate</CODE> для
преобразования ваших файлов <TT>`configure.in'</TT> для использования новых
имен макросов. See section <A HREF="autoconf-ru_13.html#SEC100">Использование <CODE>autoupdate</CODE> для обновления <CODE>configure</CODE></A>.


<P>
Некоторые макросы были заменены аналогичными, которые лучше выполняют
нужную задачу, но несовместимы по параметрам вызова.  Если вы получаете
предупреждения о вызове устаревших макросов во время запуска
<CODE>autoconf</CODE>, то можете спокойно игнорировать эти предупреждения,
но ваш скрипт <CODE>configure</CODE>, вообще, будет работать лучше, если вы
последуете советам заменить устаревший макрос на новый.  Аналогичным
образом был изменен механизм
выдачи результатов тестов.  Если вы использовали команды <CODE>echo</CODE> или
<CODE>AC_VERBOSE</CODE> (может быть, посредством <CODE>AC_COMPILE_CHECK</CODE>), то вывод
вашего скрипта <CODE>configure</CODE> будет выглядеть лучше, если вы станете
использовать макросы <CODE>AC_MSG_CHECKING</CODE> и <CODE>AC_MSG_RESULT</CODE>.
See section <A HREF="autoconf-ru_6.html#SEC58">Выдача сообщений</A>.  Эти макросы лучше всего работают при
использовании кэшированных переменных.  See section <A HREF="autoconf-ru_6.html#SEC55">Кэширование результатов</A>.




<H2><A NAME="SEC100" HREF="autoconf-ru_toc.html#TOC100">Использование <CODE>autoupdate</CODE> для обновления <CODE>configure</CODE></A></H2>
<P>
@anchor{Invoking autoupdate}


<P>
Программа <CODE>autoupdate</CODE> обновляет файл <TT>`configure.in'</TT> заменяя
вызовы старых макросов Autoconf на вызовы макросов с новыми именами. В
Autoconf версии 2 большинство макросов были переименованы для
использования более общей и понятной схемы наименования.  Для описания
новой схемы именования See section <A HREF="autoconf-ru_7.html#SEC61">Имена макросов</A>. Хотя макросы со старыми
именами все равно работают (see section <A HREF="autoconf-ru_15.html#SEC109">Старые имена макросов</A>, где приведен
список старых имен макросов и соответствующих им новых имен), но если вы
обновите свои файлы для соответствия новым именам макросов, то файлы
<TT>`configure.in'</TT> станут читабельнее, а использовать свежую
документацию по Autoconf станет проще.


<P>
<A NAME="IDX504"></A>
Если <CODE>autoupdate</CODE> запущена без аргументов, то она обновляет
<TT>`configure.in'</TT>, делая резервную копию оригинальной версии файла с
использованием суффикса <TT>`~'</TT> (или значения переменной среды
<CODE>SIMPLE_BACKUP_SUFFIX</CODE>, если она установлена). Если вы зададите
аргумент программе <CODE>autoupdate</CODE>, то она будет считывать данные из
этого файла вместо <TT>`configure.in'</TT> и выводить данные в поток
стандартного вывода.


<P>
<CODE>autoupdate</CODE> распознает следующие ключи командной строки:


<DL COMPACT>

<DT><CODE>--help</CODE>
<DD>
<DT><CODE>-h</CODE>
<DD>
Выдает список ключей командной строки и прекращает работу.

<DT><CODE>--macrodir=<VAR>dir</VAR></CODE>
<DD>
<DT><CODE>-m <VAR>dir</VAR></CODE>
<DD>
<A NAME="IDX505"></A>
Ищет файлы с макросами Autoconf в каталоге <VAR>dir</VAR>, а не в каталоге, в
который производилась установка.  Вы также задать путь к этому каталогу
в переменной среды <CODE>AC_MACRODIR</CODE>; использование этого ключа
перекрывает переменную среды.

<DT><CODE>--version</CODE>
<DD>
Выдает номер версии <CODE>autoupdate</CODE> и прекращает работу.
</DL>



<H2><A NAME="SEC101" HREF="autoconf-ru_toc.html#TOC101">Измененные результаты</A></H2>
<P>
@anchor{Changed Results}


<P>
Если вы проверяли результаты предыдущих тестов путем проверки переменной
командного процессора <CODE>DEFS</CODE>, то теперь вам необходимо
переключиться на проверку значений переменных кэша для данных
тестов. Переменная <CODE>DEFS</CODE> больше не существует во время запуска
<CODE>configure</CODE>; она создается только при генерации выходных файлов.
Это изменение поведения было сделано потому, что правильное
экранирование содержимого этой переменной оказалось слишком громоздким и 
неэффективным при
каждом вызове макроса <CODE>AC_DEFINE</CODE>. See section <A HREF="autoconf-ru_6.html#SEC56">Имена переменных кэша</A>.


<P>
Например, вот фрагмент <TT>`configure.in'</TT>, написанного для Autoconf
версии 1:



<PRE>
AC_HAVE_FUNCS(syslog)
case "$DEFS" in
*-DHAVE_SYSLOG*) ;;
*) # syslog не находится в библиотеках по умолчанию. Смотрим, есть ли он в
   # других библиотеках.
  saved_LIBS="$LIBS"
  for lib in bsd socket inet; do
    AC_CHECKING(for syslog in -l$lib)
    LIBS="$saved_LIBS -l$lib"
    AC_HAVE_FUNCS(syslog)
    case "$DEFS" in
    *-DHAVE_SYSLOG*) break ;;
    *) ;;
    esac
    LIBS="$saved_LIBS"
  done ;;
esac
</PRE>

<P>
Вот как это записывается для версии 2:



<PRE>
AC_CHECK_FUNCS(syslog)
if test $ac_cv_func_syslog = no; then
  # syslog не находится в библиотеках по умолчанию. Смотрим, есть ли он в
  # других библиотеках.
  for lib in bsd socket inet; do
    AC_CHECK_LIB($lib, syslog, [AC_DEFINE(HAVE_SYSLOG)
      LIBS="$LIBS $lib"; break])
  done
fi
</PRE>

<P>
Если вы обходили ошибку в макросе <CODE>AC_DEFINE_UNQUOTED</CODE>, добавляя
символы обратной косой черты перед кавычками, то теперь вам придется
удалить их.  Этот макрос сейчас работает предсказуемо и не рассматривает
особым образом кавычки (кроме обратных).  See section <A HREF="autoconf-ru_6.html#SEC54">Установка выходных переменных</A>.


<P>
Все логические переменные командного процессора, устанавливаемые
макросами Autoconf, используют <SAMP>`yes'</SAMP> для истинных
переменных. Большинство из них использует <SAMP>`no'</SAMP> для ложных значений,
хотя для обратной совместимости некоторые из них используют пустую
строку. Если вы полагались, что переменная командного процессора будет
установлена в что-нибудь типа <SAMP>`1'</SAMP> или <SAMP>`t'</SAMP> для истинного значения,
то вам необходимо изменить ваши тесты.




<H2><A NAME="SEC102" HREF="autoconf-ru_toc.html#TOC102">Измененное написание макросов</A></H2>
<P>
@anchor{Changed Macro Writing}


<P>
При определении ваших собственных макросов вы должны использовать
макрос <CODE>AC_DEFUN</CODE> вместо <CODE>define</CODE>. <CODE>AC_DEFUN</CODE>
автоматически вызывает макрос <CODE>AC_PROVIDE</CODE> и проверяет, что макросы,
вызываемые через <CODE>AC_REQUIRE</CODE>, не прерывают другие макросы, для
предотвращения вложенных сообщений <SAMP>`checking...'</SAMP> на экране.  На 
самом деле, старый способ не причинит вреда, но он менее удобен и менее
привлекателен.  See section <A HREF="autoconf-ru_7.html#SEC60">Определение макросов</A>.


<P>
Вы, вероятно, рассматривали макросы, поставляемые с Autoconf, как
руководство по написанию макросов.  Посмотрите на новую их версию,
потому что стиль некоторых макросов сильно улучшен, а новые возможности
активно используются.


<P>
Если вы делали хитрые вещи, используя недокументированные свойства
Autoconf (макросы, переменные, diversions), то проверьте, не нужно ли
изменить что-нибудь, чтобы учесть сделанные в Autoconf изменения.  Может 
быть, теперь вы можете пользоваться стандартной возможностью версии 2,
вместо того, чтобы упражняться в изобретательности.  Или нет.


<P>
Для ускорения работы написанных вами макросов добавьте в них поддержку
кэширования. Просмотрите все ваши тесты, может быть их нужно оформить в
виде макросов, которые вы сможете использовать в разных пакетах.


<P><HR><P>
Go to the <A HREF="autoconf-ru_1.html">first</A>, <A HREF="autoconf-ru_12.html">previous</A>, <A HREF="autoconf-ru_14.html">next</A>, <A HREF="autoconf-ru_19.html">last</A> section, <A HREF="autoconf-ru_toc.html">table of contents</A>.
<hr noshade size=1>
<b><a href="http://www.opennet.ru/docs/">Архив документации на OpenNet.ru</a>
</BODY>
</HTML>
